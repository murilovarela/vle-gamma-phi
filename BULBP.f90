INCLUDE 'subroutines/fugacity.f90'
INCLUDE 'subroutines/tocubic.f90'
INCLUDE 'subroutines/solvecubic.f90'
INCLUDE 'subroutines/choosez.f90'
INCLUDE 'subroutines/calcphi.f90'
INCLUDE 'subroutines/functions.f90'

PROGRAM BULBP
  IMPLICIT NONE

  REAL :: X1 = 0.0, X2 = 0.0, DELTAX1 = 0.01, Y1, Y2, ERROR = 0.01
  REAL :: T, PHI1, PHI2, PSAT1, PSAT2, GAMMA1, GAMMA2, PA, PA2
  INTEGER :: DONE = 0

  !ANTOINE EQUATION CONSTANTS
  REAL :: A1 = 73.304, B1 = -7122.3, C1 = -7.1424, D1 = 2.8853E-6
  REAL :: A2 = 107.02, B2 = -10237.0, C2 = -11.695, D2 = 6.8003E-18
  REAL :: E1 = 2.0, E2 = 6.0

  !VAN LAAR CONSTANTS
  REAL :: A = 489.38, B = 1173.28
  REAL :: R = 8.314

  !PENG ROBINSON VARIABLES
  REAL :: TC1 = 514.29, PC1 = 6137000, W1 = 0.649
  REAL :: TC2 = 577.2, PC2 = 3.9013E+06, W2 = 0.5890

  !FUNCTIONS
  REAL :: PSAT_F, GAMMA1_F, GAMMA2_F, PA_F, Y_F

  !FIXED TEMPERATURE IN K
  T = 343

  !PRINT FORMAT
  PRINT*, "PROCESSING..."
  OPEN(10, FILE = "OUTPUT.TXT")
  WRITE(10,*) "CONSTANT TEMPERATURE:", T, "K"
  WRITE(10,*) "P(PA) X1 X2 Y1 Y2"

  !DETERMINATION OF VAPOR PRESSURE
  PSAT1 = PSAT_F (A1, B1, C1, D1, E1, T)
  PSAT2 = PSAT_F (A2, B2, C2, D2, E2, T)

  DO WHILE (X1 < 1)
    X2 = 1 - X1

    !INITIALIZE WITH FUGACITY COEFFICIENT EQUAL 1
    PHI1 = 1
    PHI2 = 1

    !DETERMINATION OF ACTIVITY COEFFICIENT
    GAMMA1 = GAMMA1_F (A, B, X1, X2, R, T)
    GAMMA2 = GAMMA2_F (A, B, X1, X2, R, T)

    !DETERMINATION OF P
    PA = PA_F (X1, X2, GAMMA1, GAMMA2, PSAT1, PSAT2, PHI1, PHI2)

    DO WHILE (DONE .NE. 1)
      !DETERMINATION OF FUGACITY COEFFICIENT
      CALL FUGACITY (T, TC1, TC2, PC1, PC2, W1, W2, PA, R, X1, X2, PHI1, PHI2)

      !DETERMINATION OF NEW PRESSURE VALUE
      PA2 = PA_F (X1, X2, GAMMA1, GAMMA2, PSAT1, PSAT2, PHI1, PHI2)

      IF(SQRT(PA-PA2)**2 < ERROR) THEN
        DONE = 1
      END IF

      PA = PA2

      !DETERMINATION OF CONCENTRATIONS IN VAPOR-PHASE
      Y1 = Y_F (X1, GAMMA1, PSAT1, PHI1, PA)
      Y2 = Y_F (X2, GAMMA2, PSAT2, PHI2, PA)
    END DO

    !PRINT FORMAT
    WRITE(10,10) PA, X1, X2, Y1, Y2
    10    FORMAT (F12.4, F12.4,F12.4,F12.4,F12.4)

    !NEXT CONCENTRATION IN LIQUID-PHASE
    X1 = X1 + DELTAX1
    DONE = 0
  END DO

  PRINT*, "DONE."

END PROGRAM BULBP
